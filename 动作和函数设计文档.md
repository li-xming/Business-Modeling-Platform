# 动作和函数设计文档

## 1. 概述

基于Palantir本体论思想，本设计将动作和函数功能融入当前业务建模平台，实现对业务操作的抽象和管理。

## 2. 核心概念

### 2.1 操作类型（ActionType）

**作用**：代表"对某一类对象实例可以执行的业务操作"，例如"发卡、充值、挂失、黑名单同步"等；它是对"一个对象类型上的动作"的抽象。

**核心字段**：
- `targetObjectTypeId`：指向目标对象类型
- `inputSchema/outputSchema`：用JSON描述操作的入参与出参结构
- `requiresApproval`：表示是否需要审批
- `handlerFunction`：关联到具体的函数实现业务逻辑

**与其他模块关系**：
- 依赖对象类型（targetObjectTypeId），说明这是什么对象的操作
- 可选地依赖函数（handlerFunction字段），用来说明该操作由哪个函数实现
- 在删除对象类型或函数时，服务层会检查是否有操作类型仍在引用它们，避免"悬挂引用"

### 2.2 函数管理（Function）

**作用**：封装可复用的计算逻辑或规则，类似"脚本/服务函数"，用于实现具体的业务操作或接口处理逻辑。

**核心字段**：
- `code`：函数实现代码（文本）
- `inputSchema`：输入参数结构
- `returnType`：返回类型
- `version`：版本号
- `metadata`：元数据
- `domainId`：标明属于哪个业务域

**与其他模块关系**：
- 操作类型通过handlerFunction（保存函数名称）引用具体的函数
- FunctionServiceImpl.deleteFunction中会检查是否有ActionType使用该函数，防止误删
- 未来可以作为接口实现、定时任务或事件处理器的承载单元，与实例服务/查询引擎协同完成更复杂的业务流程

## 3. 功能实现

### 3.1 后端实现

**数据模型**：
- 在mock_data中添加了functions和action_types数组
- 每个函数包含id、name、description、code、inputSchema、returnType、version、metadata、domainId等字段
- 每个操作类型包含id、name、description、targetObjectTypeId、inputSchema、outputSchema、requiresApproval、handlerFunction等字段

**API接口**：
- `/api/function`：获取、创建、更新、删除函数
- `/api/action-type`：获取、创建、更新、删除操作类型
- `/api/action-type/<id>/execute`：执行操作类型

**核心逻辑**：
- 在删除函数时，检查是否有操作类型引用该函数
- 操作类型执行时，查找对应的函数并执行

### 3.2 前端实现

**组件更新**：
- 更新了ActionManager组件，添加了三个标签页：API接口管理、操作类型管理、函数管理
- 操作类型管理：展示和执行操作类型
- 函数管理：展示函数详情

**界面设计**：
- 采用标签页布局，方便用户在不同功能之间切换
- 操作类型列表展示操作名称、目标对象类型、处理函数等信息
- 函数列表展示函数名称、返回类型、版本等信息
- 支持执行操作类型并查看结果

## 4. 集成到现有业务建模功能

### 4.1 业务域地图（Domain Map）

**当前功能**：
- 可视化展示业务域及其相互关系
- D3.js力导向图展示域间关联
- 支持域的创建、导出等操作

**集成点**：
- 未来可考虑在域地图中展示域间的操作和函数依赖关系

### 4.2 域工作台（Domain Workbench）

**当前功能**：
- 模型地图：D3.js力导向图可视化展示模型及属性关系
- 模型管理：增删改查模型定义
- 共享属性：定义可在多个模型中复用的属性
- 关系管理：配置模型间的各种关系
- 语义/指标：定义业务语义和计算指标
- ER图和UML图可视化展示

**集成点**：
- 可在模型地图中展示模型上的操作类型
- 在模型管理中添加操作类型和函数的关联配置

### 4.3 模型详情（Model Detail）

**当前功能**：
- 属性管理：定义模型的具体属性
- 关系配置：配置模型间的关系
- 数据源管理：连接外部数据源
- 数据浏览：查看实际数据记录
- 语义指标：绑定和管理模型相关的语义指标
- 血缘分析：可视化展示数据血缘关系

**集成点**：
- 已在ActionManager组件中集成了操作类型和函数管理
- 支持查看和执行模型相关的操作类型
- 支持查看和管理函数

## 5. 技术架构

### 5.1 后端技术栈

- Flask：Web框架
- Python：开发语言
- JSON：数据交换格式

### 5.2 前端技术栈

- React：前端框架
- Vite：构建工具
- D3.js：数据可视化库

## 6. 运行说明

### 6.1 后端服务

```bash
cd backend
python app.py
```

后端服务将运行在 http://127.0.0.1:5000

### 6.2 前端服务

```bash
cd frontend
npm run dev
```

前端服务将运行在 http://localhost:3002

## 7. 使用示例

### 7.1 创建函数

```bash
POST /api/function
Content-Type: application/json

{
  "name": "createCard",
  "description": "创建新的卡片",
  "code": "function createCard(data) { return { id: Date.now(), ...data, status: 'active' }; }",
  "inputSchema": {"type": "object", "properties": {"cardNo": {"type": "string"}, "holderName": {"type": "string"}}},
  "returnType": "object",
  "version": "1.0.0",
  "metadata": {"author": "admin", "createdAt": "2025-12-22"},
  "domainId": 3
}
```

### 7.2 创建操作类型

```bash
POST /api/action-type
Content-Type: application/json

{
  "name": "发卡",
  "description": "创建新的卡片实例",
  "targetObjectTypeId": 9,
  "inputSchema": {"type": "object", "properties": {"cardNo": {"type": "string"}, "holderName": {"type": "string"}}},
  "outputSchema": {"type": "object", "properties": {"id": {"type": "string"}, "cardNo": {"type": "string"}, "status": {"type": "string"}}},
  "requiresApproval": false,
  "handlerFunction": "createCard"
}
```

### 7.3 执行操作类型

```bash
POST /api/action-type/1/execute
Content-Type: application/json

{
  "cardNo": "1234567890",
  "holderName": "张三"
}
```

## 8. 未来规划

1. 支持函数的版本管理和回滚
2. 实现操作类型的审批流程
3. 支持函数的在线编辑和调试
4. 实现操作类型的触发条件配置
5. 支持函数和操作类型的权限管理
6. 集成到业务流程引擎中，支持复杂业务流程的编排

## 9. 总结

本设计将Palantir本体论思想中的动作和函数概念融入到当前业务建模平台中，实现了对业务操作的抽象和管理。通过操作类型和函数的组合，可以灵活地定义和执行各种业务操作，提高了业务建模的灵活性和可扩展性。

该设计已经实现了核心功能，并与现有业务建模功能无缝集成，为用户提供了完整的业务建模解决方案。